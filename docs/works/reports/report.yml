---
ReportDefinitions:
- reportName: WorkOrderRegister
  summary: Work Order Register
  version: 1.0.0
  moduleName: works
  viewPath: workOrderRegister
  externalService:
  - entity: $.MdmsRes.egf-master.FinancialYear
    apiURL:  http://egov-mdms-service:8080/egov-mdms-service/v1/_get?moduleName=egf-master&masterName=FinancialYear&tenantId=$tenantid&filter=%5B%3F%28%40.active%3D%3Dtrue%29%5D
    keyOrder: finYearRange,startingDate,endingDate,tenantId
    tableName: tbl_financialyear
    stateData: true
  sourceColumns:
  - name: workorderdate
    label: reports.works.workorderdate
    type: epoch
    source: works
  - name: nameofwork
    label: reports.works.nameofwork
    type: string
    source: works
  - name: workordernumber
    label: reports.works.workordernumber
    type: number
    source: works
  - name: referencenoofwip
    label: reports.works.referencenoofwip
    type: string
    source: works
  - name: estimateamount
    label: reports.works.estimateamount
    type: number
    source: works
  - name: tenderamount
    label: reports.works.tenderamount
    type: number
    source: works
  - name: contractorname
    label: reports.works.contractorname
    type: string
    source: works
  - name: approvedattherateof
    label: reports.works.approvedattherateof
    type: number
    source: works
  - name: totalvalueofthework
    label: reports.works.totalvalueofthework
    type: number
    source: works
  - name: emdamount
    label: reports.works.emdamount
    type: number
    source: works
  - name: sanctionedfinyear
    label: reports.works.sanctionedfinyear
    type: string
    source: works
  - name: securitydepositamount
    label: reports.works.securitydepositamount
    type: number
    source: works
  - name: expectedcompletiondate
    label: reports.works.expectedcompletiondate
    type: epoch
    source: works
  searchParams:
  - name: fromDate
    label: reports.works.wofromDate
    type: date
    source: works
    searchClause : AND wo.workorderdate>=$fromDate
    isMandatory: false
  - name: toDate
    label: reports.works.wotoDate
    type: date
    source: works
    searchClause : AND wo.workorderdate<=$toDate
    isMandatory: false
  - name: contractorName
    label: reports.works.contractorname
    type: string
    source: works
    searchClause : AND loa.contractor=$contractorName
    isMandatory: false
  - name: amountFrom
    label: reports.works.woamountfrom
    type: number
    source: works
    searchClause : AND loae.estimateloaamount>=$amountFrom
    isMandatory: false
  - name: amountUpto
    label: reports.works.woamountupto
    type: number
    source: works
    searchClause : AND loae.estimateloaamount<=$amountUpto
    isMandatory: false

  query: select wo.workorderdate, de.nameofwork, wo.workordernumber, de.projectcode as referencenoofwip, de.estimatevalue as estimateamount, de.workvalue as tenderamount, contractor.name as contractorname, loa.tenderfinalizedpercentage as approvedattherateof, loa.loaamount as totalvalueofthework, loa.emdamountdeposited as emdamount, (select sum(amount) from egw_securitydeposit where letterofacceptance=loa.id) as securitydepositamount, (select finyear.finYearRange from (values tbl_financialyear) as finyear (finYearRange,startingDate,endingDate,tenantId) where wo.createdtime between startingDate::bigint and endingDate::bigint) as sanctionedfinyear, (select coalesce(statusdate, wo.workorderdate) from egw_offlinestatus where objecttype='WorkOrderOffline' and status='WORK_COMMENCED' and objectnumber=wo.workordernumber) as expectedcompletiondate, (select coalesce(statusdate, innerwo.workorderdate) from egw_workorder innerwo left join egw_offlinestatus fs on fs.objecttype='WorkOrderOffline' and fs.status='WORK_COMMENCED' and fs.objectnumber=innerwo.workordernumber where innerwo.workordernumber=wo.workordernumber) as expectedcompletiondate from egw_workorder wo, egw_letterofacceptance loa, egw_letterofacceptanceestimate loae, egw_detailedestimate de, egw_contractor contractor where wo.letterofacceptance=loa.id and wo.letterofacceptance=loae.letterofacceptance and loae.letterofacceptance=loa.id and loae.detailedestimate=de.estimatenumber and contractor.code=loa.contractor
