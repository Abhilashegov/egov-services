def ci_image = "egovio/ci:0.0.3"
def group = "${env.GROUP}"

try {
    node("slave"){
        checkout scm
        def matcher = envMatcher()
        def source_env = matcher[0]
        def dest_env = matcher[1]​
        def env_snapshot = load("jenkins/env_snapshot.groovy")
        def kubectl_configurer = load("jenkins/kubectl_configurer.groovy")
        def archiver = load("jenkins/archiver.groovy")

	    env_snapshot.takeSnapshot(group, source_env, ci_image)

        archiver.archiveArtifacts("jenkins/scripts/image_tags.txt")
    }
} catch (e) {
    throw e
}

@NonCPS
def envMatcher() {
  ​def m = {("${env.JOB_BASE_NAME}" =~ 'promote(.*)To(.*)')}
  def source_env = m[0][1].toLowerCase()
  def dest_env = m[0][2].toLowerCase()
  m = null
  return [source_env, dest_env]
}
